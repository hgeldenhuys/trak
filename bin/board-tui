#!/bin/sh

# Wrapper script for board TUI
# Runs via bun for reliability, with terminal reset on exit
# Includes TMPDIR workaround for macOS OpenTUI native library

# macOS requires TMPDIR workaround for OpenTUI native library
case "$(uname -s)" in
    Darwin*)
        export TMPDIR=/tmp
        ;;
esac

# Find the trak-board package directory
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
TRAK_DIR=""

# Check locations in order of preference:
# 1. npm global install (script is in node_modules/trak-board/bin/)
if [ -f "$SCRIPT_DIR/../src/tui/index.tsx" ]; then
    TRAK_DIR="$SCRIPT_DIR/.."
# 2. Local development directory
elif [ -f "$HOME/WebstormProjects/trak/src/tui/index.tsx" ]; then
    TRAK_DIR="$HOME/WebstormProjects/trak"
# 3. Current directory is trak project
elif [ -f "./src/tui/index.tsx" ] && grep -q '"name": "trak-board"' ./package.json 2>/dev/null; then
    TRAK_DIR="."
fi

# Reset terminal on exit
cleanup() {
    # Reset terminal: show cursor, exit alt screen, reset modes
    printf '\033[?25h\033[?1049l\033[?1000l\033[?1002l\033[?1003l\033[?1006l\033[?2004l\033[0m\033c'
}
trap cleanup EXIT INT TERM

if [ -n "$TRAK_DIR" ]; then
    # Run from package dir but keep user's cwd for database resolution
    # Don't use exec - we need the trap to run after bun exits
    bun run "$TRAK_DIR/src/tui/index.tsx" "$@"
    EXIT_CODE=$?
    cleanup
    exit $EXIT_CODE
else
    # Fallback to binary if available
    BINARY="$SCRIPT_DIR/.board-tui-binary"
    if [ -f "$BINARY" ]; then
        "$BINARY" "$@"
        EXIT_CODE=$?
        cleanup
        exit $EXIT_CODE
    else
        echo "Error: trak project not found"
        echo ""
        echo "Run from the trak directory:"
        echo "  cd /path/to/trak && TMPDIR=/tmp bun run tui"
        exit 1
    fi
fi
